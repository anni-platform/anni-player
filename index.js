"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var react=require("react"),useKey=_interopDefault(require("react-use/lib/useKey")),useVideo=_interopDefault(require("react-use/lib/useVideo"));const DEFAULT_FPS=24,preloadImagePromise=e=>new Promise((t,r)=>{const n=new Image;n.onload=()=>t({[e]:n}),n.onerror=e=>r(e),n.src=e}),reducer=(e,t)=>({...e,...t});function extractFrameIndexFromPath(e){try{const t=e.split("/").pop(),[r]=t.split("."),[n]=/\d+/.exec(r);if(!n)throw Error();return parseInt(n,10)}catch(t){console.error(`"${e}" does not contain a valid frame index`)}}function sortFramesAscending(e,t){return extractFrameIndexFromPath(e)-extractFrameIndexFromPath(t)}function getPlayerInitialFrameIndex(e){try{return parseInt(sessionStorage.getItem(e))||0}catch(e){return 0}}function useCanvasScrubber({playerId:e="anni-player",audioSrc:t,audioStart:r=0,fps:n=DEFAULT_FPS,frames:a=[]}){const c=react.useMemo(()=>a.sort(sortFramesAscending),[a]),u=react.useRef(null),o=react.useRef(null),i=react.useRef(getPlayerInitialFrameIndex(e)),s=react.useRef(),l=react.useRef(null),[d,m]=react.useReducer(reducer,{currentFrame:i.current,disableKeyboardEventHandlers:!1,isPlaying:!1,isMuted:!1,volume:.75,htmlImageElements:[],loadingStatus:{totalLoaded:0,total:a.length},duration:a.length/n});if(!o.current){const e=document.createElement("audio");e.src=t,e.currentTime=r,o.current=e}const f=react.useCallback((e=.75)=>{o.current&&(m({volume:e}),o.current.volume=e)},[o]),g=react.useCallback(()=>{if(!o.current)return;const e=!o.current.muted;m({isMuted:e}),o.current.muted=e},[o]),h=react.useCallback(e=>{if(!c[e]||!l.current)return;const t=u.current[c[e]],{width:r,height:n}=t;m({currentFrame:e});const a=l.current;a.width=r,a.height=n,a.getContext("2d").drawImage(t,0,0,r,n,0,0,r,n)},[c,l,u]);function y(){u.current&&0!==Object.keys(u.current).length&&m({isPlaying:!d.isPlaying})}function P(e){m({isPlaying:!1}),i.current=e,o.current.currentTime=(e/a.length*d.duration).toFixed(2),h(e)}function p(e){return function(){d.disableKeyboardEventHandlers||e()}}return react.useEffect(()=>{l.current&&d.loadingStatus.totalLoaded!==a.length&&async function(){m({loadingStatus:{total:c.length,totalLoaded:0}});const e=await Promise.all(c.map(async e=>{const t=await preloadImagePromise(e);return m({loadingStatus:{...d.loadingStatus,totalLoaded:d.loadingStatus.totalLoaded+=1}}),new Promise(e=>{e(t)})}));if(!e||0===e.length)return;u.current=e.reduce((e,t)=>({...e,...t}),{});const t=u.current[c[0]];if(!t)return;const{width:r,height:n}=t;m({frameSize:{width:r,height:n}}),h(i.current)}()},[a,l,c,h]),react.useEffect(()=>{if(o.current)return d.isPlaying&&o.current.paused?async function(){await o.current.play()}().catch(()=>null):d.isPlaying||o.current.paused||e().catch(()=>null),function(){e().catch(()=>null)};async function e(){await o.current.pause()}},[o,d.isPlaying]),react.useEffect(()=>{d.isPlaying||cancelAnimationFrame(s.current)},[d.isPlaying]),react.useEffect(()=>{if(d.isPlaying){let e,t,c=performance.now();const u=()=>{if(!d.isPlaying)return void cancelAnimationFrame(s.current);e=performance.now(),t=e-c;const l=Math.round(1e3/n);if(t>l){const t=i.current;c=e;const n=t===a.length-1?0:t+1;0===n&&(o.current.currentTime=r),i.current=n,h(i.current)}s.current=requestAnimationFrame(u)};u()}else s.current&&cancelAnimationFrame(s.current);return()=>{s.current&&cancelAnimationFrame(s.current),sessionStorage.setItem(e,i.current)}},[r,n,a,u,h,e,d]),useKey(e=>"Space"===e.code,p(y)),useKey(e=>"ArrowRight"===e.code,p(function(){const e=i.current;P(e===a.length-1?0:e+1)})),useKey(e=>"ArrowLeft"===e.code,p(function(){const e=i.current;P(0===e?a.length-1:e-1)})),{...d,canvasRef:l,getPlayPauseButtonProps:function(){return{onFocus:()=>{m({disableKeyboardEventHandlers:!0})},onBlur:()=>{m({disableKeyboardEventHandlers:!1})},onClick:y}},togglePlay:y,sortedFrames:c,toggleMuteAudio:g,seek:P,setAudioVolume:f,useVideo:useVideo}}exports.extractFrameIndexFromPath=extractFrameIndexFromPath,exports.useCanvasScrubber=useCanvasScrubber;
