"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var react=require("react"),useKey=_interopDefault(require("react-use/lib/useKey")),useVideo=_interopDefault(require("react-use/lib/useVideo"));module.exports.useVideo=useVideo;const DEFAULT_FPS=24,preloadImagePromise=e=>new Promise((r,t)=>{const n=new Image;n.onload=()=>r({[e]:n}),n.onerror=e=>t(e),n.src=e}),reducer=(e,r)=>({...e,...r});function extractFrameIndexFromPath(e){try{const r=e.split("/").pop(),[t]=r.split("."),[n]=/\d+/.exec(t);if(!n)throw Error();return parseInt(n,10)}catch(r){console.error(`"${e}" does not contain a valid frame index`)}}function sortFramesAscending(e,r){return extractFrameIndexFromPath(e)-extractFrameIndexFromPath(r)}function getPlayerInitialFrameIndex(e){try{return parseInt(sessionStorage.getItem(e))||0}catch(e){return 0}}function useCanvasScrubber({playerId:e="anni-player",fps:r=DEFAULT_FPS,frames:t=[]}){const n=react.useMemo(()=>t.sort(sortFramesAscending),[t]),a=react.useRef(null),c=react.useRef(getPlayerInitialFrameIndex(e)),o=react.useRef(),u=react.useRef(null),[s,i]=react.useReducer(reducer,{isPlaying:!1,htmlImageElements:[]}),{isPlaying:l}=s,m=react.useCallback(e=>{if(!n[e]||!u.current)return;const r=a.current[n[e]],{width:t,height:c}=r,o=u.current;o.width=t,o.height=c,o.getContext("2d").drawImage(r,0,0,t,c,0,0,t,c)},[n,u,a]);function d(){const e=a.current&&Object.keys(a.current).length>0&&!l;i({isPlaying:e})}function f(e){i({isPlaying:!1}),c.current=e,m(e)}return react.useEffect(()=>{u.current&&async function(){const e=await Promise.all(n.map(e=>preloadImagePromise(e)));if(!e||0===e.length)return;a.current=e.reduce((e,r)=>({...e,...r}),{});const r=a.current[n[0]];if(!r)return;const{width:t,height:o}=r;i({frameSize:{width:t,height:o}}),m(c.current)}()},[t,u,n,m]),react.useEffect(()=>{if(l){let e,n,a=performance.now();const u=()=>{if(!l)return;e=performance.now(),n=e-a;const s=Math.round(1e3/r);if(n>s){const r=c.current;a=e,c.current=r===t.length-1?0:r+1,m(c.current)}o.current=requestAnimationFrame(u)};u()}else o.current&&cancelAnimationFrame(o.current);return()=>{o.current&&cancelAnimationFrame(o.current),sessionStorage.setItem(e,c.current)}},[r,t,a,m,e,l]),useKey(e=>"Space"===e.code,d),useKey(e=>"ArrowRight"===e.code,function(){const e=c.current;f(e===t.length-1?0:e+1)}),useKey(e=>"ArrowLeft"===e.code,function(){const e=c.current;f(0===e?t.length-1:e-1)}),{...s,canvasRef:u,togglePlay:d,sortedFrames:n}}exports.extractFrameIndexFromPath=extractFrameIndexFromPath,exports.useCanvasScrubber=useCanvasScrubber;
