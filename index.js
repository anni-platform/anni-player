"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var react=require("react"),useKey=_interopDefault(require("react-use/lib/useKey")),useVideo=_interopDefault(require("react-use/lib/useVideo"));module.exports.useVideo=useVideo;const DEFAULT_FPS=24,preloadImagePromise=e=>new Promise((r,t)=>{const n=new Image;n.onload=()=>r({[e]:n}),n.onerror=e=>t(e),n.src=e}),reducer=(e,r)=>({...e,...r});function extractFrameIndexFromPath(e){try{const r=e.split("/").pop(),[t]=r.split("."),[n]=/\d+/.exec(t);if(!n)throw Error();return parseInt(n,10)}catch(r){console.error(`"${e}" does not contain a valid frame index`)}}function sortFramesAscending(e,r){return extractFrameIndexFromPath(e)-extractFrameIndexFromPath(r)}function getPlayerInitialFrameIndex(e){try{return parseInt(sessionStorage.getItem(e))||0}catch(e){return 0}}function useCanvasScrubber({playerId:e="anni-player",audioSrc:r,audioStart:t=0,fps:n=DEFAULT_FPS,frames:c=[]}){const u=react.useMemo(()=>c.sort(sortFramesAscending),[c]),a=react.useRef(null),o=react.useRef(null),s=react.useRef(getPlayerInitialFrameIndex(e)),i=react.useRef(),l=react.useRef(null),[d,m]=react.useReducer(reducer,{isPlaying:!1,isMuted:!1,volume:.75,htmlImageElements:[]});if(!o.current){const e=document.createElement("audio");e.src=r,e.currentTime=t,o.current=e}const{isPlaying:f}=d,g=react.useCallback((e=.75)=>{o.current&&(m({volume:e}),o.current.volume=e)},[o]),h=react.useCallback(()=>{if(!o.current)return;const e=!o.current.muted;m({isMuted:e}),o.current.muted=e},[o]),p=react.useCallback(e=>{if(!u[e]||!l.current)return;const r=a.current[u[e]],{width:t,height:n}=r,c=l.current;c.width=t,c.height=n,c.getContext("2d").drawImage(r,0,0,t,n,0,0,t,n)},[u,l,a]);function y(){const e=a.current&&Object.keys(a.current).length>0&&!f;m({isPlaying:e})}function F(e){m({isPlaying:!1}),s.current=e,p(e)}return react.useEffect(()=>{l.current&&async function(){const e=await Promise.all(u.map(e=>preloadImagePromise(e)));if(!e||0===e.length)return;a.current=e.reduce((e,r)=>({...e,...r}),{});const r=a.current[u[0]];if(!r)return;const{width:t,height:n}=r;m({frameSize:{width:t,height:n}}),p(s.current)}()},[c,l,u,p]),react.useEffect(()=>{if(o.current)return f&&o.current.paused?async function(){await o.current.play()}():f||o.current.paused||e(),function(){e()};async function e(){await o.current.pause()}},[o,f]),react.useEffect(()=>{if(f){let e,r,u=performance.now();const a=()=>{if(!f)return;e=performance.now(),r=e-u;const l=Math.round(1e3/n);if(r>l){const r=s.current;u=e;const n=r===c.length-1?0:r+1;0===n&&(o.current.currentTime=t),s.current=n,p(s.current)}i.current=requestAnimationFrame(a)};a()}else i.current&&cancelAnimationFrame(i.current);return()=>{i.current&&cancelAnimationFrame(i.current),sessionStorage.setItem(e,s.current)}},[n,c,a,p,e,f]),useKey(e=>"Space"===e.code,y),useKey(e=>"ArrowRight"===e.code,function(){const e=s.current;F(e===c.length-1?0:e+1)}),useKey(e=>"ArrowLeft"===e.code,function(){const e=s.current;F(0===e?c.length-1:e-1)}),{...d,canvasRef:l,togglePlay:y,sortedFrames:u,toggleMuteAudio:h,setAudioVolume:g}}exports.extractFrameIndexFromPath=extractFrameIndexFromPath,exports.useCanvasScrubber=useCanvasScrubber;
