"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var react=require("react"),useKey=_interopDefault(require("react-use/lib/useKey")),useAudio=_interopDefault(require("react-use/lib/useAudio"));require("react-use/lib/useEffectOnce");var useVideo=_interopDefault(require("react-use/lib/useVideo"));const DEFAULT_FPS=24,preloadImagePromise=e=>new Promise((r,t)=>{const n=new Image;n.onload=()=>r({[e]:n}),n.onerror=e=>t(e),n.src=e}),reducer=(e,r)=>({...e,...r});function extractFrameIndexFromPath(e){try{const r=e.split("/").pop(),[t]=r.split("."),[n]=/\d+/.exec(t);if(!n)throw Error();return parseInt(n,10)}catch(r){console.error(`"${e}" does not contain a valid frame index`)}}function sortFramesAscending(e,r){return extractFrameIndexFromPath(e)-extractFrameIndexFromPath(r)}function getPlayerInitialFrameIndex(e){try{return parseInt(sessionStorage.getItem(e))||0}catch(e){return 0}}function useCanvasScrubber({playerId:e="anni-player",audioSrc:r,audioStartSeconds:t=0,fps:n=DEFAULT_FPS,frames:c=[]}){const a=(c.length-1)/n,s=react.useMemo(()=>c.sort(sortFramesAscending),[c]),u=react.useRef(null),o=react.useRef(getPlayerInitialFrameIndex(e)),i=react.useRef(),l=react.useRef(null),[f,d]=react.useReducer(reducer,{isPlaying:!1,htmlImageElements:[]}),{isPlaying:m}=f,[g,h,p]=useAudio({src:r}),y=react.useCallback(()=>{p.seek(t)},[p,t]);react.useEffect(()=>{if(m&&!h.isPlaying){const e=o.current?o.current/c.length*a+t:t;console.log("seek",e),p.play()}else!m&&h.isPlaying&&p.pause()},[p,o,m]),react.useEffect(()=>{(0===o.current||h.time>a+t)&&y()},[r,o,y,h,a]);const F=react.useCallback(e=>{if(!s[e]||!l.current)return;const r=u.current[s[e]],{width:t,height:n}=r,c=l.current;c.width=t,c.height=n,c.getContext("2d").drawImage(r,0,0,t,n,0,0,t,n)},[s]);function P(){const e=u.current&&Object.keys(u.current).length>0&&!m;d({isPlaying:e})}function x(e){d({isPlaying:!1}),o.current=e,F(e)}return react.useEffect(()=>{l.current&&async function(){const e=await Promise.all(s.map(e=>preloadImagePromise(e)));if(!e||0===e.length)return;u.current=e.reduce((e,r)=>({...e,...r}),{});const r=u.current[s[0]];if(!r)return;const{width:t,height:n}=r;d({frameSize:{width:t,height:n}}),F(o.current)}()},[c,l,s,F]),react.useEffect(()=>{if(m){let e,r,t=performance.now();const a=()=>{if(!m)return;e=performance.now(),r=e-t;const s=Math.round(1e3/n);if(r>s){const r=o.current;t=e;const n=r===c.length-1;o.current=n?0:r+1,F(o.current)}i.current=requestAnimationFrame(a)};a()}else i.current&&cancelAnimationFrame(i.current);return()=>{i.current&&cancelAnimationFrame(i.current),sessionStorage.setItem(e,o.current)}},[n,c,u,F,e,m,y]),useKey(e=>"Space"===e.code,P),useKey(e=>"ArrowRight"===e.code,function(){const e=o.current;x(e===c.length-1?0:e+1)}),useKey(e=>"ArrowLeft"===e.code,function(){const e=o.current;x(0===e?c.length-1:e-1)}),{...f,canvasRef:l,togglePlay:P,sortedFrames:s,audio:{element:g,state:h,controls:p}}}exports.useVideo=useVideo,exports.extractFrameIndexFromPath=extractFrameIndexFromPath,exports.useCanvasScrubber=useCanvasScrubber;
