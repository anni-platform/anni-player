import{useMemo as r,useRef as e,useReducer as t,useCallback as n,useEffect as c}from"react";const o=24,i=r=>new Promise((e,t)=>{const n=new Image;n.onload=()=>e({[r]:n}),n.onerror=r=>t(r),n.src=r}),a=(r,e)=>({...r,...e});function s(r){try{const e=r.split("/").pop(),[t]=e.split("."),[n]=/\d+/.exec(t);if(!n)throw Error();return parseInt(n,10)}catch(e){console.error(`"${r}" does not contain a valid frame index`)}}function u(r,e){return s(r)-s(e)}export default function({playerId:s="anni-player",fps:l=o,frames:m=[]}){const f=r(()=>m.sort(u),[m]),h=e(null),g=e(function(r){try{return parseInt(sessionStorage.getItem(r))||0}catch(r){return 0}}(s)),d=e(),p=e(null),[w,y]=t(a,{isPlaying:!1,htmlImageElements:[]}),{isPlaying:I}=w,P=n(r=>{if(!f[r]||!p.current)return;const e=h.current[f[r]],{width:t,height:n}=e,c=p.current;c.width=t,c.height=n,c.getContext("2d").drawImage(e,0,0,t,n,0,0,t,n)},[f,p,h]);return c(()=>{p.current&&async function(){const r=await Promise.all(f.map(r=>i(r)));if(!r||0===r.length)return;h.current=r.reduce((r,e)=>({...r,...e}),{});const e=h.current[f[0]];if(!e)return;const{width:t,height:n}=e;y({frameSize:{width:t,height:n}}),P(g.current)}()},[m,p,f,P]),c(()=>{if(I){let r,e,t=performance.now();const n=()=>{if(!I)return;r=performance.now(),e=r-t;const c=Math.round(1e3/l);if(e>c){const e=g.current;t=r,g.current=e===m.length-1?0:e+1,P(g.current)}d.current=requestAnimationFrame(n)};n()}else d.current&&cancelAnimationFrame(d.current);return()=>{d.current&&cancelAnimationFrame(d.current),sessionStorage.setItem(s,g.current)}},[l,m,h,P,s,I]),{...w,canvasRef:p,togglePlay:function(){const r=h.current&&Object.keys(h.current).length>0&&!I;y({isPlaying:r})},sortedFrames:f}}export{s as extractFrameIndexFromPath};
