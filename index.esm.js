import{useMemo as e,useRef as t,useReducer as r,useCallback as n,useEffect as c}from"react";import o from"react-use/lib/useKey";import i from"react-use/lib/useAudio";import"react-use/lib/useEffectOnce";export{default as useVideo}from"react-use/lib/useVideo";const s=24,u=e=>new Promise((t,r)=>{const n=new Image;n.onload=()=>t({[e]:n}),n.onerror=e=>r(e),n.src=e}),a=(e,t)=>({...e,...t});function l(e){try{const t=e.split("/").pop(),[r]=t.split("."),[n]=/\d+/.exec(r);if(!n)throw Error();return parseInt(n,10)}catch(t){console.error(`"${e}" does not contain a valid frame index`)}}function f(e,t){return l(e)-l(t)}function m({playerId:l="anni-player",audioSrc:m,audioStartSeconds:g=0,fps:d=s,frames:h=[]}){const p=(h.length-1)/d,y=e(()=>h.sort(f),[h]),w=t(null),P=t(function(e){try{return parseInt(sessionStorage.getItem(e))||0}catch(e){return 0}}(l)),I=t(),S=t(null),[A,b]=r(a,{isPlaying:!1,htmlImageElements:[]}),{isPlaying:x}=A,[F,k,E]=i({src:m}),v=n(()=>{E.seek(g)},[E,g]);c(()=>{if(x&&!k.isPlaying){const e=P.current?P.current/h.length*p+g:g;console.log("seek",e),E.play()}else!x&&k.isPlaying&&E.pause()},[E,P,x]),c(()=>{(0===P.current||k.time>p+g)&&v()},[m,P,v,k,p]);const O=n(e=>{if(!y[e]||!S.current)return;const t=w.current[y[e]],{width:r,height:n}=t,c=S.current;c.width=r,c.height=n,c.getContext("2d").drawImage(t,0,0,r,n,0,0,r,n)},[y]);function R(){const e=w.current&&Object.keys(w.current).length>0&&!x;b({isPlaying:e})}function V(e){b({isPlaying:!1}),P.current=e,O(e)}return c(()=>{S.current&&async function(){const e=await Promise.all(y.map(e=>u(e)));if(!e||0===e.length)return;w.current=e.reduce((e,t)=>({...e,...t}),{});const t=w.current[y[0]];if(!t)return;const{width:r,height:n}=t;b({frameSize:{width:r,height:n}}),O(P.current)}()},[h,S,y,O]),c(()=>{if(x){let e,t,r=performance.now();const n=()=>{if(!x)return;e=performance.now(),t=e-r;const c=Math.round(1e3/d);if(t>c){const t=P.current;r=e;const n=t===h.length-1;P.current=n?0:t+1,O(P.current)}I.current=requestAnimationFrame(n)};n()}else I.current&&cancelAnimationFrame(I.current);return()=>{I.current&&cancelAnimationFrame(I.current),sessionStorage.setItem(l,P.current)}},[d,h,w,O,l,x,v]),o(e=>"Space"===e.code,R),o(e=>"ArrowRight"===e.code,function(){const e=P.current;V(e===h.length-1?0:e+1)}),o(e=>"ArrowLeft"===e.code,function(){const e=P.current;V(0===e?h.length-1:e-1)}),{...A,canvasRef:S,togglePlay:R,sortedFrames:y,audio:{element:F,state:k,controls:E}}}export{l as extractFrameIndexFromPath,m as useCanvasScrubber};
