import{useMemo as t,useRef as e,useReducer as r,useCallback as n,useEffect as c}from"react";import o from"react-use/lib/useKey";import u from"react-use/lib/useVideo";module.exports.useVideo=u;const a=24,i=t=>new Promise((e,r)=>{const n=new Image;n.onload=()=>e({[t]:n}),n.onerror=t=>r(t),n.src=t}),s=(t,e)=>({...t,...e});function l(t){try{const e=t.split("/").pop(),[r]=e.split("."),[n]=/\d+/.exec(r);if(!n)throw Error();return parseInt(n,10)}catch(e){console.error(`"${t}" does not contain a valid frame index`)}}function d(t,e){return l(t)-l(e)}function m({playerId:u="anni-player",audioSrc:l,audioStart:m=0,fps:g=a,frames:f=[]}){const h=t(()=>f.sort(d),[f]),p=e(null),w=e(null),y=e(function(t){try{return parseInt(sessionStorage.getItem(t))||0}catch(t){return 0}}(u)),S=e(),I=e(null),[P,A]=r(s,{currentFrame:y.current,isPlaying:!1,isMuted:!1,volume:.75,htmlImageElements:[],loadingStatus:{totalLoaded:0,total:f.length},duration:f.length/g});if(!w.current){const t=document.createElement("audio");t.src=l,t.currentTime=m,w.current=t}const{isPlaying:F}=P,x=n((t=.75)=>{w.current&&(A({volume:t}),w.current.volume=t)},[w]),v=n(()=>{if(!w.current)return;const t=!w.current.muted;A({isMuted:t}),w.current.muted=t},[w]),L=n(t=>{if(!h[t]||!I.current)return;const e=p.current[h[t]],{width:r,height:n}=e;A({currentFrame:t});const c=I.current;c.width=r,c.height=n,c.getContext("2d").drawImage(e,0,0,r,n,0,0,r,n)},[h,I,p]);function M(){const t=p.current&&Object.keys(p.current).length>0&&!F;A({isPlaying:t})}function b(t){A({isPlaying:!1}),y.current=t,w.current.currentTime=(t/f.length*P.duration).toFixed(2),L(t)}return c(()=>{I.current&&async function(){A({loadingStatus:{total:h.length,totalLoaded:0}});const t=await Promise.all(h.map(async t=>{const e=await i(t);return A({loadingStatus:{...P.loadingStatus,totalLoaded:P.loadingStatus.totalLoaded+=1}}),new Promise(t=>{t(e)})}));if(!t||0===t.length)return;p.current=t.reduce((t,e)=>({...t,...e}),{});const e=p.current[h[0]];if(!e)return;const{width:r,height:n}=e;A({frameSize:{width:r,height:n}}),L(y.current)}()},[f,I,h,L]),c(()=>{if(w.current)return F&&w.current.paused?async function(){await w.current.play()}().catch(()=>null):F||w.current.paused||t().catch(()=>null),function(){t().catch(()=>null)};async function t(){await w.current.pause()}},[w,F]),c(()=>{if(F){let t,e,r=performance.now();const n=()=>{if(!F)return;t=performance.now(),e=t-r;const c=Math.round(1e3/g);if(e>c){const e=y.current;r=t;const n=e===f.length-1?0:e+1;0===n&&(w.current.currentTime=m),y.current=n,L(y.current)}S.current=requestAnimationFrame(n)};n()}else S.current&&cancelAnimationFrame(S.current);return()=>{S.current&&cancelAnimationFrame(S.current),sessionStorage.setItem(u,y.current)}},[g,f,p,L,u,F]),o(t=>"Space"===t.code,M),o(t=>"ArrowRight"===t.code,function(){const t=y.current;b(t===f.length-1?0:t+1)}),o(t=>"ArrowLeft"===t.code,function(){const t=y.current;b(0===t?f.length-1:t-1)}),{...P,canvasRef:I,togglePlay:M,sortedFrames:h,toggleMuteAudio:v,seek:b,setAudioVolume:x}}export{l as extractFrameIndexFromPath,m as useCanvasScrubber};
