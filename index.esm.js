import{useMemo as r,useRef as e,useReducer as t,useCallback as n,useEffect as c}from"react";import o from"react-use/lib/useKey";const i=24,a=r=>new Promise((e,t)=>{const n=new Image;n.onload=()=>e({[r]:n}),n.onerror=r=>t(r),n.src=r}),u=(r,e)=>({...r,...e});function s(r){try{const e=r.split("/").pop(),[t]=e.split("."),[n]=/\d+/.exec(t);if(!n)throw Error();return parseInt(n,10)}catch(e){console.error(`"${r}" does not contain a valid frame index`)}}function l(r,e){return s(r)-s(e)}export default function({playerId:s="anni-player",fps:f=i,frames:m=[]}){const g=r(()=>m.sort(l),[m]),h=e(null),d=e(function(r){try{return parseInt(sessionStorage.getItem(r))||0}catch(r){return 0}}(s)),p=e(),w=e(null),[y,I]=t(u,{isPlaying:!1,htmlImageElements:[]}),{isPlaying:P}=y,x=n(r=>{if(!g[r]||!w.current)return;const e=h.current[g[r]],{width:t,height:n}=e,c=w.current;c.width=t,c.height=n,c.getContext("2d").drawImage(e,0,0,t,n,0,0,t,n)},[g,w,h]);function A(){const r=h.current&&Object.keys(h.current).length>0&&!P;I({isPlaying:r})}function F(r){I({isPlaying:!1}),d.current=r,x(r)}return c(()=>{w.current&&async function(){const r=await Promise.all(g.map(r=>a(r)));if(!r||0===r.length)return;h.current=r.reduce((r,e)=>({...r,...e}),{});const e=h.current[g[0]];if(!e)return;const{width:t,height:n}=e;I({frameSize:{width:t,height:n}}),x(d.current)}()},[m,w,g,x]),c(()=>{if(P){let r,e,t=performance.now();const n=()=>{if(!P)return;r=performance.now(),e=r-t;const c=Math.round(1e3/f);if(e>c){const e=d.current;t=r,d.current=e===m.length-1?0:e+1,x(d.current)}p.current=requestAnimationFrame(n)};n()}else p.current&&cancelAnimationFrame(p.current);return()=>{p.current&&cancelAnimationFrame(p.current),sessionStorage.setItem(s,d.current)}},[f,m,h,x,s,P]),o(r=>"Space"===r.code,A),o(r=>"ArrowRight"===r.code,function(){const r=d.current;F(r===m.length-1?0:r+1)}),o(r=>"ArrowLeft"===r.code,function(){const r=d.current;F(0===r?m.length-1:r-1)}),{...y,canvasRef:w,togglePlay:A,sortedFrames:g}}export{s as extractFrameIndexFromPath};
