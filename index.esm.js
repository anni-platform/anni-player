import{useMemo as t,useRef as e,useReducer as n,useCallback as r,useEffect as o}from"react";import a from"react-use/lib/useKey";import c from"react-use/lib/useVideo";const u=24,i=t=>new Promise((e,n)=>{const r=new Image;r.onload=()=>e({[t]:r}),r.onerror=t=>n(t),r.src=t}),s=(t,e)=>({...t,...e});function l(t){try{const e=t.split("/").pop(),[n]=e.split("."),[r]=/\d+/.exec(n);if(!r)throw Error();return parseInt(r,10)}catch(e){console.error(`"${t}" does not contain a valid frame index`)}}function d(t,e){return l(t)-l(e)}function m({playerId:l="anni-player",audioSrc:m,audioStart:g=0,fps:f=u,frames:h=[]}){const y=t(()=>h.sort(d),[h]),p=e(null),P=e(null),w=e(function(t){try{return parseInt(sessionStorage.getItem(t))||0}catch(t){return 0}}(l)),S=e(),b=e(null),[v,F]=n(s,{currentFrame:w.current,disableKeyboardEventHandlers:!1,isPlaying:!1,isMuted:!1,volume:.75,htmlImageElements:[],loadingStatus:{totalLoaded:0,total:h.length},duration:h.length/f});if(!P.current){const t=document.createElement("audio");t.src=m,t.currentTime=g,P.current=t}const A=r((t=.75)=>{P.current&&(F({volume:t}),P.current.volume=t)},[P]),I=r(()=>{if(!P.current)return;const t=!P.current.muted;F({isMuted:t}),P.current.muted=t},[P]),E=r(t=>{if(!y[t]||!b.current)return;const e=p.current[y[t]],{width:n,height:r}=e;F({currentFrame:t});const o=b.current;o.width=n,o.height=r,o.getContext("2d").drawImage(e,0,0,n,r,0,0,n,r)},[y,b,p]);function L(){p.current&&0!==Object.keys(p.current).length&&F({isPlaying:!v.isPlaying})}function x(t){F({isPlaying:!1}),w.current=t,P.current.currentTime=(t/h.length*v.duration).toFixed(2),E(t)}function K(t){return function(){v.disableKeyboardEventHandlers||t()}}return o(()=>{b.current&&v.loadingStatus.totalLoaded!==h.length&&async function(){F({loadingStatus:{total:y.length,totalLoaded:0}});const t=await Promise.all(y.map(async t=>{const e=await i(t);return F({loadingStatus:{...v.loadingStatus,totalLoaded:v.loadingStatus.totalLoaded+=1}}),new Promise(t=>{t(e)})}));if(!t||0===t.length)return;p.current=t.reduce((t,e)=>({...t,...e}),{});const e=p.current[y[0]];if(!e)return;const{width:n,height:r}=e;F({frameSize:{width:n,height:r}}),E(w.current)}()},[h,b,y,E]),o(()=>{if(P.current)return v.isPlaying&&P.current.paused?async function(){await P.current.play()}().catch(()=>null):v.isPlaying||P.current.paused||t().catch(()=>null),function(){t().catch(()=>null)};async function t(){await P.current.pause()}},[P,v.isPlaying]),o(()=>{v.isPlaying||cancelAnimationFrame(S.current)},[v.isPlaying]),o(()=>{if(v.isPlaying){let t,e,n=performance.now();const r=()=>{if(!v.isPlaying)return void cancelAnimationFrame(S.current);t=performance.now(),e=t-n;const o=Math.round(1e3/f);if(e>o){const e=w.current;n=t;const r=e===h.length-1?0:e+1;0===r&&(P.current.currentTime=g),w.current=r,E(w.current)}S.current=requestAnimationFrame(r)};r()}else S.current&&cancelAnimationFrame(S.current);return()=>{S.current&&cancelAnimationFrame(S.current),sessionStorage.setItem(l,w.current)}},[g,f,h,p,E,l,v]),a(t=>"Space"===t.code,K(L)),a(t=>"ArrowRight"===t.code,K(function(){const t=w.current;x(t===h.length-1?0:t+1)})),a(t=>"ArrowLeft"===t.code,K(function(){const t=w.current;x(0===t?h.length-1:t-1)})),{...v,canvasRef:b,getPlayPauseButtonProps:function(){return{onFocus:()=>{F({disableKeyboardEventHandlers:!0})},onBlur:()=>{F({disableKeyboardEventHandlers:!1})},onClick:L}},togglePlay:L,sortedFrames:y,toggleMuteAudio:I,seek:x,setAudioVolume:A,useVideo:c}}export{l as extractFrameIndexFromPath,m as useCanvasScrubber};
