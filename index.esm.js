import{useMemo as e,useRef as r,useReducer as t,useCallback as n,useEffect as c}from"react";import o from"react-use/lib/useKey";export{default as useVideo}from"react-use/lib/useVideo";const i=24,s=e=>new Promise((r,t)=>{const n=new Image;n.onload=()=>r({[e]:n}),n.onerror=e=>t(e),n.src=e}),u=(e,r)=>({...e,...r});function a(e){try{const r=e.split("/").pop(),[t]=r.split("."),[n]=/\d+/.exec(t);if(!n)throw Error();return parseInt(n,10)}catch(r){console.error(`"${e}" does not contain a valid frame index`)}}function l(e,r){return a(e)-a(r)}function f({playerId:a="anni-player",fps:f=i,frames:m=[]}){const g=e(()=>m.sort(l),[m]),h=r(null),d=r(function(e){try{return parseInt(sessionStorage.getItem(e))||0}catch(e){return 0}}(a)),p=r(),w=r(null),[y,I]=t(u,{isPlaying:!1,htmlImageElements:[]}),{isPlaying:P}=y,x=n(e=>{if(!g[e]||!w.current)return;const r=h.current[g[e]],{width:t,height:n}=r,c=w.current;c.width=t,c.height=n,c.getContext("2d").drawImage(r,0,0,t,n,0,0,t,n)},[g,w,h]);function A(){const e=h.current&&Object.keys(h.current).length>0&&!P;I({isPlaying:e})}function F(e){I({isPlaying:!1}),d.current=e,x(e)}return c(()=>{w.current&&async function(){const e=await Promise.all(g.map(e=>s(e)));if(!e||0===e.length)return;h.current=e.reduce((e,r)=>({...e,...r}),{});const r=h.current[g[0]];if(!r)return;const{width:t,height:n}=r;I({frameSize:{width:t,height:n}}),x(d.current)}()},[m,w,g,x]),c(()=>{if(P){let e,r,t=performance.now();const n=()=>{if(!P)return;e=performance.now(),r=e-t;const c=Math.round(1e3/f);if(r>c){const r=d.current;t=e,d.current=r===m.length-1?0:r+1,x(d.current)}p.current=requestAnimationFrame(n)};n()}else p.current&&cancelAnimationFrame(p.current);return()=>{p.current&&cancelAnimationFrame(p.current),sessionStorage.setItem(a,d.current)}},[f,m,h,x,a,P]),o(e=>"Space"===e.code,A),o(e=>"ArrowRight"===e.code,function(){const e=d.current;F(e===m.length-1?0:e+1)}),o(e=>"ArrowLeft"===e.code,function(){const e=d.current;F(0===e?m.length-1:e-1)}),{...y,canvasRef:w,togglePlay:A,sortedFrames:g}}export{a as extractFrameIndexFromPath,f as useCanvasScrubber};
