import{useMemo as e,useRef as r,useReducer as t,useCallback as n,useEffect as o}from"react";import c from"react-use/lib/useKey";import i from"react-use/lib/useVideo";module.exports.useVideo=i;const s=24,u=e=>new Promise((r,t)=>{const n=new Image;n.onload=()=>r({[e]:n}),n.onerror=e=>t(e),n.src=e}),a=(e,r)=>({...e,...r});function l(e){try{const r=e.split("/").pop(),[t]=r.split("."),[n]=/\d+/.exec(t);if(!n)throw Error();return parseInt(n,10)}catch(r){console.error(`"${e}" does not contain a valid frame index`)}}function m(e,r){return l(e)-l(r)}function f({playerId:i="anni-player",fps:l=s,frames:f=[]}){const g=e(()=>f.sort(m),[f]),h=r(null),d=r(function(e){try{return parseInt(sessionStorage.getItem(e))||0}catch(e){return 0}}(i)),p=r(),w=r(null),[y,I]=t(a,{isPlaying:!1,htmlImageElements:[]}),{isPlaying:P}=y,x=n(e=>{if(!g[e]||!w.current)return;const r=h.current[g[e]],{width:t,height:n}=r,o=w.current;o.width=t,o.height=n,o.getContext("2d").drawImage(r,0,0,t,n,0,0,t,n)},[g,w,h]);function A(){const e=h.current&&Object.keys(h.current).length>0&&!P;I({isPlaying:e})}function F(e){I({isPlaying:!1}),d.current=e,x(e)}return o(()=>{w.current&&async function(){const e=await Promise.all(g.map(e=>u(e)));if(!e||0===e.length)return;h.current=e.reduce((e,r)=>({...e,...r}),{});const r=h.current[g[0]];if(!r)return;const{width:t,height:n}=r;I({frameSize:{width:t,height:n}}),x(d.current)}()},[f,w,g,x]),o(()=>{if(P){let e,r,t=performance.now();const n=()=>{if(!P)return;e=performance.now(),r=e-t;const o=Math.round(1e3/l);if(r>o){const r=d.current;t=e,d.current=r===f.length-1?0:r+1,x(d.current)}p.current=requestAnimationFrame(n)};n()}else p.current&&cancelAnimationFrame(p.current);return()=>{p.current&&cancelAnimationFrame(p.current),sessionStorage.setItem(i,d.current)}},[l,f,h,x,i,P]),c(e=>"Space"===e.code,A),c(e=>"ArrowRight"===e.code,function(){const e=d.current;F(e===f.length-1?0:e+1)}),c(e=>"ArrowLeft"===e.code,function(){const e=d.current;F(0===e?f.length-1:e-1)}),{...y,canvasRef:w,togglePlay:A,sortedFrames:g}}export{l as extractFrameIndexFromPath,f as useCanvasScrubber};
