import{useMemo as t,useRef as e,useReducer as r,useCallback as n,useEffect as o}from"react";import c from"react-use/lib/useKey";import u from"react-use/lib/useVideo";module.exports.useVideo=u;const a=24,i=t=>new Promise((e,r)=>{const n=new Image;n.onload=()=>e({[t]:n}),n.onerror=t=>r(t),n.src=t}),s=(t,e)=>({...t,...e});function l(t){try{const e=t.split("/").pop(),[r]=e.split("."),[n]=/\d+/.exec(r);if(!n)throw Error();return parseInt(n,10)}catch(e){console.error(`"${t}" does not contain a valid frame index`)}}function d(t,e){return l(t)-l(e)}function m({playerId:u="anni-player",audioSrc:l,audioStart:m=0,fps:f=a,frames:g=[]}){const h=t(()=>g.sort(d),[g]),p=e(null),w=e(null),y=e(function(t){try{return parseInt(sessionStorage.getItem(t))||0}catch(t){return 0}}(u)),S=e(),I=e(null),[P,A]=r(s,{isPlaying:!1,isMuted:!1,volume:.75,htmlImageElements:[],loadingStatus:{totalLoaded:0,total:g.length}});if(!w.current){const t=document.createElement("audio");t.src=l,t.currentTime=m,w.current=t}const{isPlaying:v}=P,x=n((t=.75)=>{w.current&&(A({volume:t}),w.current.volume=t)},[w]),L=n(()=>{if(!w.current)return;const t=!w.current.muted;A({isMuted:t}),w.current.muted=t},[w]),F=n(t=>{if(!h[t]||!I.current)return;const e=p.current[h[t]],{width:r,height:n}=e,o=I.current;o.width=r,o.height=n,o.getContext("2d").drawImage(e,0,0,r,n,0,0,r,n)},[h,I,p]);function M(){const t=p.current&&Object.keys(p.current).length>0&&!v;A({isPlaying:t})}function b(t){A({isPlaying:!1}),y.current=t,F(t)}return o(()=>{I.current&&async function(){A({loadingStatus:{total:h.length,totalLoaded:0}});const t=await Promise.all(h.map(async t=>{const e=await i(t);return A({loadingStatus:{...P.loadingStatus,totalLoaded:P.loadingStatus.totalLoaded+=1}}),new Promise(t=>{t(e)})}));if(!t||0===t.length)return;p.current=t.reduce((t,e)=>({...t,...e}),{});const e=p.current[h[0]];if(!e)return;const{width:r,height:n}=e;A({frameSize:{width:r,height:n}}),F(y.current)}()},[g,I,h,F]),o(()=>{if(w.current)return v&&w.current.paused?async function(){await w.current.play()}():v||w.current.paused||t(),function(){t()};async function t(){await w.current.pause()}},[w,v]),o(()=>{if(v){let t,e,r=performance.now();const n=()=>{if(!v)return;t=performance.now(),e=t-r;const o=Math.round(1e3/f);if(e>o){const e=y.current;r=t;const n=e===g.length-1?0:e+1;0===n&&(w.current.currentTime=m),y.current=n,F(y.current)}S.current=requestAnimationFrame(n)};n()}else S.current&&cancelAnimationFrame(S.current);return()=>{S.current&&cancelAnimationFrame(S.current),sessionStorage.setItem(u,y.current)}},[f,g,p,F,u,v]),c(t=>"Space"===t.code,M),c(t=>"ArrowRight"===t.code,function(){const t=y.current;b(t===g.length-1?0:t+1)}),c(t=>"ArrowLeft"===t.code,function(){const t=y.current;b(0===t?g.length-1:t-1)}),{...P,canvasRef:I,togglePlay:M,sortedFrames:h,toggleMuteAudio:L,setAudioVolume:x}}export{l as extractFrameIndexFromPath,m as useCanvasScrubber};
